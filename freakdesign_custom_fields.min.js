/*


      ############# 
    ##            *## 
   #        %      **#
  #        %%%    ***#
 #       %%F%D%%   ****#
#          %%%    *****#
#   ###     %     ###***# 
#  # ####       #### #**# 
#  #     #     #     #**# 
#   #####  # #  #####***# 
#         #   #  *******# 
 ### #           **# ### 
     # - - - - - - #                 
      | | | | | | |
	
     freakdesign.com               
      CUSTOM FIELDS

*/
(function(){if(typeof Shopify!="undefined")if(typeof jQuery!="undefined")if(!$("html.freakdesign_custom_fields").length){var d=document,url=d.URL,html=d.documentElement;html.className+=" freakdesign_custom_fields";if(url.indexOf("myshopify.com/admin")>1){var _=function(){var translation={no_fields:"No custom fields found",error_get_metafields:"Error getting product metafields",loaded:"Custom Field tool loaded"};var v={debug:false,author:"freakdesign",alpha:false,omega:false,wait:1E3,products:{},collections:{},
linklists:{},pages:{},namespace:"custom_fields",namespace_new:"c_f",whitelist:[],key_articles:"[a]",key_collections:"[c]",key_customers:"[cu]",key_pages:"[g]",key_orders:"[o]",key_products:"[p]",marker_collection:"[_c]",marker_file:"[_f]",marker_int:"[_i]",marker_page:"[_g]",marker_product:"[_p]",marker_textarea:"[_t]",marker_linklist:"[_l]",help_file:"//freakdesign-us.s3.amazonaws.com/shopify/custom_fields/freakdesign-custom-fields-for-shopify-guide.pdf",css:"//rawgithub.com/freakdesign/shopify-custom-fields/master/freakdesign_custom_fields.css"};
return{data:function(a,b){if("undefined"===typeof b)return v[a];v[a]=b},translate:function(a){return translation[a]},notice:function(m,err){if(err)Shopify.Flash.error(m);else Shopify.Flash.notice(m)},escape_html:function(s){var div=document.createElement("div");div.appendChild(document.createTextNode(s));return div.innerHTML},unescape_html:function(a){if(void 0===a)return"";var b=document.createElement("div");b.innerHTML=a;return(a=b.childNodes[0])?a.nodeValue:""},fd_modal:function(show,content,title,
persist){var my_fdmodal=$("#fdmodal");if(show){if(my_fdmodal.length)my_fdmodal.remove();var m=$('<div id="fdmodal" class="modalWindow"><div class="main content"><header></header></div></div>');if(title)m.find("header").html("<h2>"+title+"</h2>");if(content){var d=$("<div/>",{}).append(content);m.find("div.main.content").append(d)}if(!persist)m.fadeIn().on("click",function(){_.fd_modal(false)});else{var mclose=$('<a href="#" class="close-modal">X</a>');mclose.on("click",function(){_.fd_modal(false);
return false});m.find("header").prepend(mclose).end().fadeIn()}$("body").append(m)}else my_fdmodal.off("click").remove()},load_css:function(){if($("#css_custom_fields").length===0){var css=document.createElement("link");css.type="text/css";css.rel="stylesheet";css.id="css_custom_fields";css.href=_.data("css");document.body.appendChild(css)}},get_json:function(p,callback,v){$.ajax({type:"GET",url:p,dataType:"json",success:function(d){callback(d);if(v)_.data(v,d)},fail:function(){_.notice("Error getting JSON",
true)}})},custom_fields_preload:function(a){a=typeof a!=="undefined"?a:"collections";$.ajax({type:"GET",url:"/admin/"+a+".json",dataType:"json",success:function(d){_.data("collections",d);_.setup_custom_fields(_.data("alpha"))},error:function(){_.notice("Failed to preload all data. Expect errors...",true)}})},remove_brackets:function(key){key=key.replace(/\[([^\]]*)\]*/g,"");key=key.charAt(0).toUpperCase()+key.slice(1).replace(/-/g," ").replace(/_/g," ");return key},setup_custom_fields:function(template){console.log("setup_custom_fields");
var url="/admin/"+_.data("alpha")+"/"+_.data("omega")+"/metafields.json",custom_field_panel=$('<div class="row section"><div class="span6 section-summary"><h1>Custom Fields</h1><p>Custom Fields are created by your developer and shown here when using the Custom Fields tool.</p><p>Refer to the <a target="_blank" href="'+_.data("help_file")+'">help file</a> for more info.</p></div><div class="span18 section-content"></div></div>'),save=$('header .header-right input[value="Save"]').eq(0),insertafter=
$("div.row.section").eq(0);if(_.data("alpha")==="customers"){insertafter=$("section.order-tags.ppt").eq(0);save=$('header .header-right a[data-route="routes.customers[customer].edit"]').eq(0)}else if(_.data("alpha")==="orders"){save=$("header .header-right ul").eq(1);insertafter=$("section.box.box-details").eq(0);console.log(save.length,insertafter.length);if(save.length===0)_.notice("Can not find where to put the Custom Fields save button")}else if(_.data("alpha")==="pages"||_.data("alpha")==="articles")save=
$('header .header-right button[type="submit"]').eq(0);console.log(insertafter);insertafter.after(custom_field_panel);var a=$("<a/>",{"class":"btn","href":"#"}).text("Save with Custom Fields").on("click",function(){var t=$(this);var inputs=$("div.custom_fields_box input, div.custom_fields_box textarea");if(inputs.length){t.attr("style","color:rgba(0,0,0,0)").addClass("is-loading");_.notice("Saving Custom Fields");var save_meta=function(i){var ci=inputs.eq(i),key=ci.attr("data-key"),value=ci.val(),
ajax_type="POST",ns=ci.attr("data-namespace"),value_type=ci.attr("data-type"),metaJSON={"metafield":{"namespace":ns,"key":key,"value":value,"value_type":value_type}},ajax_url=url,skip=false;if(value.length===0&&ci.attr("data-mid")&&ci.attr("data-pid")){ajax_type="DELETE";ajax_url="/admin/"+_.data("alpha")+"/"+ci.attr("data-pid")+"/metafields/"+ci.attr("data-mid")+".json"}else if(value.length===0)skip=true;if(!skip)$.ajax({type:ajax_type,url:ajax_url,dataType:"json",data:metaJSON,success:function(d){i++;
if(i<inputs.length)save_meta(i);else{t.attr("style","").removeClass("is-loading");if((save.text()==="Save"||save.val()==="Save")&&!save.is("[disabled]"))save.click()}},fail:function(d){_.notice("Error saving custom fields",true);t.attr("style","").removeClass("is-loading")}});else{i++;if(i<inputs.length)save_meta(i);else{save.click();t.attr("style","").removeClass("is-loading")}}};save_meta(0)}else _.notice("No fields to save",true);return false});save.after(a);_.data("fields",[]);$.ajax({type:"GET",
url:"/admin/metafields.json",dataType:"json",success:function(d){var to_append="",makerow=function(){return false};for(var i=0,len=d.metafields.length;i<len;i++){var namespace=d.metafields[i].namespace,namespace_len=namespace.length,whitelisted=false;if(_.data("whitelist").length>0)if($.inArray(namespace,_.data("whitelist"))>-1)whitelisted=true;var legacyCheck=d.metafields[i].value+d.metafields[i].key;var meta_type=_.key_check(legacyCheck);if(meta_type.limit===_.data("alpha")||meta_type.limit===false)if(namespace===
_.data("namespace")||namespace===_.data("namespace_new")||whitelisted){var key=d.metafields[i].key,myarray=_.data("fields");myarray.push(d.metafields[i].key);_.data("fields",myarray);key=_.remove_brackets(key);to_append+='<div class="half">';if(d.metafields[i].value.length>1)to_append+='<label for="product-type"><span class="tooltip tooltip-bottom" style="display:inline-block;position:relative">'+key+'<span class="tooltip-container"><span class="tooltip-label">'+d.metafields[i].namespace+"."+d.metafields[i].key+
'</span></span></span><span class="note block">'+_.remove_brackets(d.metafields[i].value)+"</span></label>";else to_append+='<label for="product-type">'+key+"</label>";if(meta_type.field=="textarea")to_append+='<textarea data-namespace="'+namespace+'" name="'+d.metafields[i].key+'" placeholder="'+_.remove_brackets(d.metafields[i].key)+'" data-key="'+d.metafields[i].key+'" data-type="'+d.metafields[i].value_type+'"></textarea>';else to_append+='<input data-namespace="'+namespace+'" data-cffield="'+
meta_type.field+'" data-cftype="'+meta_type.type+'" name="'+d.metafields[i].key+'" placeholder="'+_.remove_brackets(key)+'" value="" data-key="'+d.metafields[i].key+'" data-type="'+d.metafields[i].value_type+'">';to_append+="</div>"}}var has_fields=true;if(!to_append.length){to_append='<div class="box warning">'+_.translate("no_fields")+"</div>";has_fields=false}custom_field_panel.find("div.section-content").append('<div class="custom_fields_box clearfix fadein"><div class="content">'+to_append+"</div></div>");
if(has_fields){custom_field_panel.find('input[data-cftype="collection"]').each(function(){var t=$(this);t.after(_.build_select(t.attr("name"),"collection"))});custom_field_panel.find('input[data-cftype="linklist"]').each(function(){});custom_field_panel.find('input[data-cftype="product"]').each(function(){});$.ajax({type:"GET",url:url,dataType:"json",success:function(d){for(var i=0,len=d.metafields.length;i<len;i++){whitelisted=false;if(_.data("whitelist").length>0)if($.inArray(d.metafields[i].namespace,
_.data("whitelist"))>-1)whitelisted=true;if(d.metafields[i].namespace===_.data("namespace")||d.metafields[i].namespace===_.data("namespace_new")||whitelisted)if(d.metafields[i].namespace!=="global"&&d.metafields[i].key!=="description_tag"){var input=$('input[data-key="'+d.metafields[i].key+'"],textarea[data-key="'+d.metafields[i].key+'"]');input.val(d.metafields[i].value).attr({"data-val":_.escape_html(d.metafields[i].value),"data-mid":d.metafields[i].id,"data-pid":_.data("omega")})}}},error:function(d){_.notice(_.translate("error_get_metafields"),
true)}})}},error:function(d){_.notice(_.translate("error_get_metafields"),true)}})},build_select:function(a,select_type){if(a){var c=_.data("collections"),select=$("<select />",{"data-ref":a}).change(function(event){var t=$(this),v=t.val(),f=$('input[name="'+a+'"]').eq(0);if(v)f.val(v);else{var resetVal=_.unescape_html(f.attr("data-val"));resetVal?f.val(resetVal):f.val("")}});if(c&&Object.keys(c.collections).length>1){var options='<option value="">Pick a collection</option>';for(var i=0,len=Object.keys(c.collections).length;i<
len;i++)options+='<option value="'+c.collections[i].handle+'">'+c.collections[i].title+"</option>";select.html(options);return select}else _.notice("Error, invalid collection length",true)}},type_check:function(a,b){var r=false;if(b)a+=b;if(a.indexOf(_.data("key_products"))<0&&a.indexOf(_.data("key_pages"))<0&&a.indexOf(_.data("key_collections"))<0&&a.indexOf(_.data("key_articles"))<0)r=true;else if(a.indexOf(_.data("key_products"))>-1&&_.data("alpha")==="products")r=true;else if(a.indexOf(_.data("key_articles"))>
-1&&_.data("alpha")==="articles")r=true;else if(a.indexOf(_.data("key_collections"))>-1&&_.data("alpha")==="custom_collections")r=true;else if(a.indexOf(_.data("key_collections"))>-1&&_.data("alpha")==="smart_collections")r=true;else if(a.indexOf(_.data("key_collections"))>-1&&_.data("alpha")==="collections")r=true;return r},key_check:function(a){var c={field:"text",type:false,limit:false};if(a.indexOf(_.data("marker_collection"))>-1){c.field="select";c.type="collection"}else if(a.indexOf(_.data("marker_textarea"))>
-1){c.field="textarea";c.type="string"}if(a.indexOf(_.data("key_articles"))>-1)c.limit="articles";else if(a.indexOf(_.data("key_collections"))>-1){c.limit="custom_collections";if(_.data("alpha")==="smart_collections")c.limit="smart_collections";if(_.data("alpha")==="collections")c.limit="collections"}else if(a.indexOf(_.data("key_customers"))>-1)c.limit="customers";else if(a.indexOf(_.data("key_pages"))>-1)c.limit="pages";else if(a.indexOf(_.data("key_orders"))>-1)c.limit="orders";else if(a.indexOf(_.data("key_products"))>
-1)c.limit="products";return c},load_ui:function(){_.load_css();if($("#freakdesign_main_button").length===0){var freakdesign_main_button=$("<a>",{id:"freakdesign_main_button"}).text("Custom Fields ON").on("click",function(){_.fd_modal(true,'<p><img src="//freakdesign-us.s3.amazonaws.com/shopify/custom_fields/i/modal_header.png" /></p><p>Custom Fields is "honor-ware", which means that we trust each other to be nice. As the developer of it, I\'m committed to keeping the tool something that\'s actually useful. By releasing new features and correcting possible bugs on a constant basis I can do just that, but I need your support. If you use it and intend to keep it, please sponsor its development by making a small <a target="_blank" href="http://shopify.freakdesign.com.au/#donate2">contribution</a>.</p><p>A small <a href="'+
_.data("help_file")+'" target="_blank">help guide</a> is avalable in PDF format.</p><p>Developers should consider using <a target="_blank" href="http://shopify.freakdesign.com.au/#ShopifyFD">ShopifyFD</a> to create the metafields this tool requires.</p>',"Custom Fields by Freakdesign",true);return false});var navli=$("<li />",{});navli.append(freakdesign_main_button);$("a.sidebar-link.dashboard").parent().before(navli)}},init:function(){$("html").data("loaded",true);$.ajax({type:"GET",url:"/admin/metafields.json",
dataType:"json",error:function(){_.notice("Error reading shop metafields",true)},success:function(d){_.data("shop_metafields",d);for(var i=0,len=d.metafields.length;i<len;i++)if(d.metafields[i].key==="whitelist"&&d.metafields[i].namespace==="custom_fields_config"){var w=d.metafields[i].value.replace(/\s/g,"").split(",");_.data("whitelist",w)}_.load_ui();setInterval(function(){if(!$("#content").hasClass("loading")){var u_array=document.URL.split("#")[0].split("?")[0].split("/"),alpha=u_array[u_array.length-
2],omega=document.URL.split("/").pop();if(alpha!==_.data("alpha")||omega!==_.data("omega"))if(omega!=="next"&&omega!=="prev"){_.data("alpha",alpha);_.data("omega",omega);if(_.data("alpha")=="articles"&&!isNaN(_.data("omega")))_.custom_fields_preload();else if(_.data("alpha")=="pages"&&!isNaN(_.data("omega")))_.custom_fields_preload();else if(_.data("alpha")=="products"&&!isNaN(_.data("omega")))_.custom_fields_preload();else if(_.data("alpha")=="customers"&&!isNaN(_.data("omega")))_.custom_fields_preload();
else if(_.data("alpha")=="orders"&&!isNaN(_.data("omega")))_.custom_fields_preload();else if(_.data("alpha")=="collections"&&!isNaN(_.data("omega")))_.custom_fields_preload("collections");else if(_.data("alpha")=="smart_collections"&&!isNaN(_.data("omega")))_.custom_fields_preload("collections");else if(_.data("alpha")=="custom_collections"&&!isNaN(_.data("omega")))_.custom_fields_preload("collections")}}},_.data("wait"));setInterval(function(){_.load_ui()},5E3);_.notice(_.translate("loaded"))}})}}}();
_.load_css();_.init()}else alert("Not admin")}else alert("Already loaded the tool?");else alert("No jquery found!");else alert("Shopify javascript is not found. Are you in your admin?")})();