/*


      ############# 
    ##            *## 
   #        %      **#
  #        %%%    ***#
 #       %%F%D%%   ****#
#          %%%    *****#
#   ###     %     ###***# 
#  # ####       #### #**# 
#  #     #     #     #**# 
#   #####  # #  #####***# 
#         #   #  *******# 
 ### #           **# ### 
     # - - - - - - #                 
      | | | | | | |
	
     freakdesign.com               

CUSTOM FIELDS


*/
(function(){if(typeof Shopify!="undefined")if(typeof jQuery!="undefined")if(!$("html.freakdesign_custom_fields").length){var d=document,url=d.URL,html=$("html");html.addClass("freakdesign_custom_fields");if(url.indexOf("myshopify.com/admin")>1){var _=function(){var translation={no_fields:"No custom fields found",error_get_metafields:"Error getting product metafields",loaded:"Custom Field tool loaded"};var v={debug:false,author:"freakdesign",version:20131014,alpha:false,omega:false,wait:1E3,namespace:"custom_fields",
namespace_new:"c_f",key_articles:"[a]",key_collections:"[c]",key_pages:"[g]",key_products:"[p]",marker_collection:"[_c]",marker_file:"[_f]",marker_int:"[_i]",marker_page:"[_g]",marker_product:"[_p]"};return{data:function(a,b){if("undefined"===typeof b)return v[a];v[a]=b},translate:function(a){return translation[a]},notice:function(m,err){if(err)Shopify.Flash.error(m);else Shopify.Flash.notice(m)},escape_html:function(s){var div=document.createElement("div");div.appendChild(document.createTextNode(s));
return div.innerHTML},unescape_html:function(s){var div=document.createElement("div");div.innerHTML=s;var child=div.childNodes[0];return child?child.nodeValue:""},fd_modal:function(show,content,title,persist){var my_fdmodal=$("#fdmodal");if(show){if(my_fdmodal.length)my_fdmodal.remove();var m=$('<div id="fdmodal" class="modalWindow"><div class="main content"><header></header></div></div>');if(title)m.find("header").html("<h2>"+title+"</h2>");if(content){var d=$("<div/>",{}).append(content);m.find("div.main.content").append(d)}if(!persist)m.fadeIn().on("click",
function(){_.fd_modal(false)});else{var mclose=$('<a href="#" class="close-modal">x</a>');mclose.on("click",function(){_.fd_modal(false);return false});m.find("header").prepend(mclose).end().fadeIn()}$("body").append(m)}else my_fdmodal.off("click").remove()},load_css:function(){var css=document.createElement("link");css.type="text/css";css.rel="stylesheet";css.id="css_custom_fields";css.href="//rawgithub.com/freakdesign/shopify-custom-fields/master/freakdesign_custom_fields.css";document.body.appendChild(css)},
get_json:function(p,callback,v){$.ajax({type:"GET",url:p,dataType:"json",success:function(d){callback(d);if(v)_.data(v,d)},fail:function(){}})},get_collections:function(callback){if(typeof callback==="function")if(_.data("collections"))callback(_.data("collections"));else _.get_json("/admin/collections.json",callback,"collections")},show_collections:function(d){},setup_product_preload:function(){$.ajax({type:"GET",url:"/admin/collections.json",dataType:"json",success:function(d){_.data("collections",
d);_.setup_product()},fail:function(){_.notice("Failed to preload all data. Expect errors...",true)}})},setup_product:function(){var url="/admin/"+_.data("alpha")+"/"+_.data("omega")+"/metafields.json",custom_field_panel=$('<div class="row section"><div class="span6 section-summary"><h1>Custom Fields</h1><p>Custom Fields are created by your developer and shown here when using the Custom Fields tool. These fields are available on all products.</p></div><div class="span18 section-content"></div></div>'),
custom_field_product_panel=$('<div class="row section"><div class="span6 section-summary"><h1>Product Custom Fields</h1><p>Product Custom Fields are unique to this product alone and shown here when using the Custom Fields tool.</p></div><div class="span18 section-content"></div></div>'),insertafter=$("div.row.section.inventory").eq(0),save=$('input[data-addclass-btn-primary="product.canSave"]').eq(0);insertafter.after(custom_field_panel,custom_field_product_panel);var a=$("<a/>",{"class":"btn","href":"#"}).text("Save with Custom Fields").on("click",
function(){var inputs=$("div.custom_fields_box input");if(inputs.length){var save_meta=function(i){var ci=inputs.eq(i),key=ci.attr("data-key"),value=ci.val(),ajax_type="POST",value_type=ci.attr("data-type"),metaJSON={"metafield":{"namespace":_.data("namespace"),"key":key,"value":value,"value_type":value_type}};var ajax_url=url,skip=false;if(value.length==0&&(ci.attr("data-mid")&&ci.attr("data-pid"))){ajax_type="DELETE";ajax_url="/admin/products/"+ci.attr("data-pid")+"/metafields/"+ci.attr("data-mid")+
".json"}else if(value.length==0)skip=true;if(!skip)$.ajax({type:ajax_type,url:ajax_url,dataType:"json",data:metaJSON,success:function(d){i++;if(i<inputs.length)save_meta(i);else save.click()}});else{i++;if(i<inputs.length)save_meta(i);else save.click()}};save_meta(0)}return false});save.after(a);_.data("fields",[]);$.ajax({type:"GET",url:"/admin/metafields.json",dataType:"json",success:function(d){var to_append="",makerow=function(){return false};for(var i=0,len=d.metafields.length;i<len;i++){var namespace=
d.metafields[i].namespace,namespace_len=namespace.length;if(namespace.indexOf(_.data("namespace"))===0||namespace.indexOf(_.data("namespace_new"))===0){console.log("namespace exists:"+namespace);var key=d.metafields[i].key,myarray=_.data("fields"),meta_type=_.key_check(key);console.log(meta_type.type);myarray.push(d.metafields[i].key);_.data("fields",myarray);key=key.replace(/\[([^\]]*)\]*/g,"");key=key.charAt(0).toUpperCase()+key.slice(1).replace(/-/g," ");to_append+='<div class="half"><label for="product-type">'+
key+' <span class="note">'+d.metafields[i].value+"</span></label>";to_append+='<input data-cffield="'+meta_type.field+'" data-cftype="'+meta_type.type+'" name="'+d.metafields[i].key+'" placeholder="'+key+'" value="" data-key="'+d.metafields[i].key+'" data-type="'+d.metafields[i].value_type+'">';to_append+="</div>"}}if(!to_append.length)to_append=_.translate("no_fields");custom_field_panel.find("div.section-content").append('<div class="custom_fields_box clearfix"><div class="content">'+to_append+
"</div></div>");custom_field_panel.find('input[data-cftype="collection"]').each(function(){console.log("I can see a collection field");var t=$(this);t.after(_.build_select(t.attr("name")))});$.ajax({type:"GET",url:url,dataType:"json",success:function(d){var to_append="";for(var i=0,len=d.metafields.length;i<len;i++)if(d.metafields[i].namespace==_.data("namespace"))if($.inArray(d.metafields[i].key,_.data("fields"))<0){console.log("Product specific custom field");var key=d.metafields[i].key;key=key.charAt(0).toUpperCase()+
key.slice(1).replace(/-/g," ");to_append+='<div class="half"><label for="product-type">Blank?'+key+'</label><input name="'+d.metafields[i].key+'" placeholder="'+d.metafields[i].key+'" value="'+d.metafields[i].value+'" data-key="'+d.metafields[i].key+'"  data-type="'+d.metafields[i].value_type+'"></div>'}else{console.log("Global custom field");var input=$('input[data-key="'+d.metafields[i].key+'"]');input.val(d.metafields[i].value).attr({"data-val":_.escape_html(d.metafields[i].value),"data-mid":d.metafields[i].id,
"data-pid":_.data("omega")})}if(!to_append.length)to_append=_.translate("no_fields");custom_field_product_panel.find("div.section-content").append('<div class="custom_fields_box clearfix"><div class="content">'+to_append+"</div></div>")},error:function(d){_.notice(_.translate("error_get_metafields"),true)}})},error:function(d){_.notice(_.translate("error_get_metafields"),true)}})},setup_page:function(a){},setup_article:function(a){},build_select:function(a){console.log("build_select: "+a);var select=
$("<select />",{"data-ref":a}).change(function(event){var t=$(this),v=t.val(),f=$('input[name="'+a+'"]').eq(0);if(v)f.val(v);else f.val(_.unescape_html(f.attr("data-val")))});var c=_.data("collections");if(c&&Object.keys(c.collections).length>1){var options='<option value="">Pick a collection</option>';for(var i=0,len=Object.keys(c.collections).length;i<len;i++)options+='<option value="'+c.collections[i].handle+'">'+c.collections[i].title+"</option>";select.html(options);return select}else console.log("Invalid length")},
key_check:function(a){var c={field:"text",type:false,limit:false};if(a.indexOf(_.data("key_pages"))>0)console.log(_.data("key_pages")+" Marker found");else if(a.indexOf(_.data("key_products"))>0)console.log(_.data("key_products")+" Marker found");else if(a.indexOf(_.data("key_articles"))>0)console.log(_.data("key_articles")+" Marker found");else if(a.indexOf(_.data("key_collections"))>0)console.log(_.data("key_collections")+" Marker found");if(a.indexOf(_.data("marker_collection"))){c.field="select";
c.type="collection"}return c},init:function(){var freakdesign_main_button=$("<a>",{id:"freakdesign_main_button"}).text("Custom Fields ON").on("click",function(){_.fd_modal(true,'<p>Custom Fields is "honor-ware", which means that we trust each other to be nice. As the developer of it, I\'m committed to keep the tool something that\'s actually useful. By releasing new features and correcting possible bugs on a constant basis I can do just that, but I need your support. If you use it and intend to keep it, please sponsor its development by making a small <a target="_blank" href="http://shopify.freakdesign.com.au/#donate2">contribution</a>.</p><p>Developers should consider using <a target="_blank" href="http://shopify.freakdesign.com.au/#ShopifyFD">ShopifyFD</a> to create the metafields this tool requires.</p>',
"Custom Fields by Freakdesign",true);return false});var shopify_button=$("h1.header-item-container").eq(0);shopify_button.html("").append(freakdesign_main_button);setInterval(function(){if(!$("#content").hasClass("loading")){var u_array=d.URL.split("#")[0].split("?")[0].split("/"),alpha=u_array[u_array.length-2],omega=d.URL.split("/").pop();if(alpha!==_.data("alpha")||omega!==_.data("omega")){_.data("alpha",alpha);_.data("omega",omega);if(_.data("alpha")=="articles"&&!isNaN(_.data("omega")))_.setup_article();
if(_.data("alpha")=="pages"&&!isNaN(_.data("omega")))_.setup_page();if(_.data("alpha")=="products"&&!isNaN(_.data("omega")))_.setup_product_preload()}}},_.data("wait"));_.notice(_.translate("loaded"))}}}();_.load_css();_.init()}else alert("not admin")}else alert("Are you sure you are in your admin?");else alert("no jquery");else alert("Shopify javascript is not found. Are you in your admin?")})();