/*


      ############# 
    ##            *## 
   #        %      **#
  #        %%%    ***#
 #       %%F%D%%   ****#
#          %%%    *****#
#   ###     %     ###***# 
#  # ####       #### #**# 
#  #     #     #     #**# 
#   #####  # #  #####***# 
#         #   #  *******# 
 ### #           **# ### 
     # - - - - - - #                 
      | | | | | | |
	
     freakdesign.com               
      CUSTOM FIELDS

*/
(function(){if("undefined"!=typeof Shopify)if("undefined"!=typeof jQuery)if($("html.freakdesign_custom_fields").length)alert("Already loaded the tool?");else{var r=document,u=r.URL;r.documentElement.className+=" freakdesign_custom_fields";if(1<u.indexOf("myshopify.com/admin")){var a=function(){var r={no_fields:"No custom fields found",error_get_metafields:"Error getting product metafields",loaded:"Custom Field tool loaded"},t={debug:!1,author:"freakdesign",alpha:!1,omega:!1,wait:1E3,products:{},collections:{},
linklists:{},pages:{},namespace:"custom_fields",namespace_new:"c_f",whitelist:[],key_articles:"[a]",key_collections:"[c]",key_customers:"[cu]",key_pages:"[g]",key_orders:"[o]",key_products:"[p]",marker_collection:"[_c]",marker_file:"[_f]",marker_int:"[_i]",marker_page:"[_g]",marker_product:"[_p]",marker_textarea:"[_t]",marker_linklist:"[_l]",help_file:"//freakdesign-us.s3.amazonaws.com/shopify/custom_fields/freakdesign-custom-fields-for-shopify-guide.pdf",css:"//rawgithub.com/freakdesign/shopify-custom-fields/master/freakdesign_custom_fields.css"};
return{data:function(a,c){if("undefined"===typeof c)return t[a];t[a]=c},translate:function(a){return r[a]},notice:function(a,c){c?Shopify.Flash.error(a):Shopify.Flash.notice(a)},escape_html:function(a){var c=document.createElement("div");c.appendChild(document.createTextNode(a));return c.innerHTML},unescape_html:function(a){if(void 0===a)return"";var c=document.createElement("div");c.innerHTML=a;return(a=c.childNodes[0])?a.nodeValue:""},fd_modal:function(b,c,d,f){var n=$("#fdmodal");if(b){n.length&&
n.remove();b=$('<div id="fdmodal" class="modalWindow"><div class="main content"><header></header></div></div>');d&&b.find("header").html("<h2>"+d+"</h2>");c&&(c=$("<div/>",{}).append(c),b.find("div.main.content").append(c));if(f)f=$('<a href="#" class="close-modal">X</a>'),f.on("click",function(){a.fd_modal(!1);return!1}),b.find("header").prepend(f).end().fadeIn();else b.fadeIn().on("click",function(){a.fd_modal(!1)});$("body").append(b)}else n.off("click").remove()},load_css:function(){if(0===$("#css_custom_fields").length){var b=
document.createElement("link");b.type="text/css";b.rel="stylesheet";b.id="css_custom_fields";b.href=a.data("css");document.getElementsByTagName("head")[0].appendChild(b)}},get_json:function(b,c,d){"undefined"===typeof c&&(c=!1);"undefined"===typeof b&&(b=!1);"undefined"===typeof d&&(d=!1);b&&$.ajax({type:"GET",url:b,dataType:"json",success:function(b){c&&c(b);d&&a.data(d,b)},error:function(){a.notice("Error getting JSON",!0)}})},custom_fields_preload:function(b){$.ajax({type:"GET",url:"/admin/"+("undefined"!==
typeof b?b:"collections")+".json",dataType:"json",success:function(b){a.data("collections",b);a.setup_custom_fields(a.data("alpha"))},error:function(){a.notice("Failed to preload all data. Expect errors...",!0)}})},remove_brackets:function(a){a=a.replace(/\[([^\]]*)\]*/g,"");return a=a.charAt(0).toUpperCase()+a.slice(1).replace(/-/g," ").replace(/_/g," ")},save_custom_fields:function(a){},setup_custom_fields:function(b){var c="/admin/"+a.data("alpha")+"/"+a.data("omega")+"/metafields.json",d=$('<div class="row section"><div id="cf-summary" class="span6 section-summary"><h1>Custom Fields</h1><p>Custom Fields are created by your developer and shown here when using the Custom Fields tool.</p><p>Refer to the <a target="_blank" href="'+
a.data("help_file")+'">help file</a> for more info.</p></div><div class="span18 section-content"></div></div>'),f=$('header .header-right input[value="Save"]').eq(0);b=$("div.row.section").eq(0);if("customers"===a.data("alpha"))b=$("section.order-tags.ppt").eq(0),f=$('header .header-right a[data-route="routes.customers[customer].edit"]').eq(0);else if("orders"===a.data("alpha"))f=$("header .header-right ul").eq(1),b=$("section.box.box-details").eq(0);else if("pages"===a.data("alpha")||"articles"===
a.data("alpha"))f=$('header .header-right button[type="submit"]').eq(0);b.length?b.after(d):a.notice("The HTML in this page is not as expected. I can not add the Custom Field panel",!0);b=$("<a/>",{"class":"btn",href:"#"}).text("Save with Custom Fields").on("click",function(){var b=$(this),d=$("div.custom_fields_box input, div.custom_fields_box textarea");if(d.length){b.attr("style","color:rgba(0,0,0,0)").addClass("is-loading");a.notice("Saving Custom Fields");var e=function(p){var h=d.eq(p),k=h.attr("data-key"),
l=h.val(),m="POST",q=h.attr("data-namespace"),s=h.attr("data-type"),k={metafield:{namespace:q,key:k,value:l,value_type:s}},q=c,s=!1;0===l.length&&h.attr("data-mid")&&h.attr("data-pid")?(m="DELETE",q="/admin/"+a.data("alpha")+"/"+h.attr("data-pid")+"/metafields/"+h.attr("data-mid")+".json"):0===l.length&&(s=!0);s?(p++,p<d.length?e(p):(f.click(),b.attr("style","").removeClass("is-loading"))):$.ajax({type:m,url:q,dataType:"json",data:k,success:function(a){p++;p<d.length?e(p):(b.attr("style","").removeClass("is-loading"),
"Save"!==f.text()&&"Save"!==f.val()||f.is("[disabled]")||f.click())},fail:function(c){a.notice("Error saving custom fields",!0);b.attr("style","").removeClass("is-loading")}})};e(0)}else a.notice("No fields to save",!0);return!1});f.length?f.after(b):a.notice("Can not find where to put the Custom Fields save button",!0);a.data("fields",[]);$.ajax({type:"GET",url:"/admin/metafields.json",dataType:"json",success:function(b){for(var g="",e=0,f=b.metafields.length;e<f;e++){var h=b.metafields[e].namespace,
k=!1;0<a.data("whitelist").length&&-1<$.inArray(h,a.data("whitelist"))&&(k=!0);var l=a.key_check(b.metafields[e].value+b.metafields[e].key);if(l.limit===a.data("alpha")||!1===l.limit)if(h===a.data("namespace")||h===a.data("namespace_new")||k){var m=b.metafields[e].key,q=a.data("fields");q.push(b.metafields[e].key);a.data("fields",q);m=a.remove_brackets(m);g+='<div class="half">';g=1<b.metafields[e].value.length?g+('<label for="product-type"><span class="tooltip tooltip-bottom" style="display:inline-block;position:relative">'+
m+'<span class="tooltip-container"><span class="tooltip-label">'+b.metafields[e].namespace+"."+b.metafields[e].key+'</span></span></span><span class="note block">'+a.remove_brackets(b.metafields[e].value)+"</span></label>"):g+('<label for="product-type">'+m+"</label>");g="textarea"==l.field?g+('<textarea data-namespace="'+h+'" name="'+b.metafields[e].key+'" placeholder="'+a.remove_brackets(b.metafields[e].key)+'" data-key="'+b.metafields[e].key+'" data-type="'+b.metafields[e].value_type+'"></textarea>'):
g+('<input data-namespace="'+h+'" data-cffield="'+l.field+'" data-cftype="'+l.type+'" name="'+b.metafields[e].key+'" placeholder="'+a.remove_brackets(m)+'" value="" data-key="'+b.metafields[e].key+'" data-type="'+b.metafields[e].value_type+'">');g+="</div>"}}b=!0;g.length||(g='<div class="box warning">'+a.translate("no_fields")+"</div>",b=!1);d.find("div.section-content").append('<div class="custom_fields_box clearfix fadein"><div class="content">'+g+"</div></div>");b&&(d.find('input[data-cftype="collection"]').each(function(){var b=
$(this);b.after(a.build_select(b.attr("name"),"collection"))}),d.find('input[data-cftype="linklist"]').each(function(){}),d.find('input[data-cftype="product"]').each(function(){}),$.ajax({type:"GET",url:c,dataType:"json",success:function(b){for(var c=0,d=b.metafields.length;c<d;c++)k=!1,0<a.data("whitelist").length&&-1<$.inArray(b.metafields[c].namespace,a.data("whitelist"))&&(k=!0),(b.metafields[c].namespace===a.data("namespace")||b.metafields[c].namespace===a.data("namespace_new")||k)&&"global"!==
b.metafields[c].namespace&&"description_tag"!==b.metafields[c].key&&$('input[data-key="'+b.metafields[c].key+'"],textarea[data-key="'+b.metafields[c].key+'"]').val(b.metafields[c].value).attr({"data-val":a.escape_html(b.metafields[c].value),"data-mid":b.metafields[c].id,"data-pid":a.data("omega")})},error:function(b){a.notice(a.translate("error_get_metafields"),!0)}}),$("#cf-summary").append('<a href="#" class="btn disabled">Save ONLY custom fields</a>'))},error:function(b){a.notice(a.translate("error_get_metafields"),
!0)}})},build_select:function(b,c){if(b){var d=a.data("collections"),f=$("<select />",{"data-ref":b}).change(function(c){var d=$(this).val();c=$('input[name="'+b+'"]').eq(0);d?c.val(d):(d=a.unescape_html(c.attr("data-val")))?c.val(d):c.val("")});if(d&&1<Object.keys(d.collections).length){for(var n='<option value="">Pick a collection</option>',g=0,e=Object.keys(d.collections).length;g<e;g++)n+='<option value="'+d.collections[g].handle+'">'+d.collections[g].title+"</option>";f.html(n);return f}a.notice("Error, invalid collection length",
!0)}},type_check:function(b,c){var d=!1;c&&(b+=c);0>b.indexOf(a.data("key_products"))&&0>b.indexOf(a.data("key_pages"))&&0>b.indexOf(a.data("key_collections"))&&0>b.indexOf(a.data("key_articles"))?d=!0:-1<b.indexOf(a.data("key_products"))&&"products"===a.data("alpha")?d=!0:-1<b.indexOf(a.data("key_articles"))&&"articles"===a.data("alpha")?d=!0:-1<b.indexOf(a.data("key_collections"))&&"custom_collections"===a.data("alpha")?d=!0:-1<b.indexOf(a.data("key_collections"))&&"smart_collections"===a.data("alpha")?
d=!0:-1<b.indexOf(a.data("key_collections"))&&"collections"===a.data("alpha")&&(d=!0);return d},key_check:function(b){var c={field:"text",type:!1,limit:!1};-1<b.indexOf(a.data("marker_collection"))?(c.field="select",c.type="collection"):-1<b.indexOf(a.data("marker_textarea"))&&(c.field="textarea",c.type="string");-1<b.indexOf(a.data("key_articles"))?c.limit="articles":-1<b.indexOf(a.data("key_collections"))?(c.limit="custom_collections","smart_collections"===a.data("alpha")&&(c.limit="smart_collections"),
"collections"===a.data("alpha")&&(c.limit="collections")):-1<b.indexOf(a.data("key_customers"))?c.limit="customers":-1<b.indexOf(a.data("key_pages"))?c.limit="pages":-1<b.indexOf(a.data("key_orders"))?c.limit="orders":-1<b.indexOf(a.data("key_products"))&&(c.limit="products");return c},load_ui:function(){if(0===$("#freakdesign_main_button").length){var b=$("<a>",{id:"freakdesign_main_button","class":"fadein"}).text("Custom Fields ON").on("click",function(){a.fd_modal(!0,'<p><img src="//freakdesign-us.s3.amazonaws.com/shopify/custom_fields/i/modal_header.png" /></p><p>Custom Fields is "honor-ware", which means that we trust each other to be nice. As the developer of it, I\'m committed to keeping the tool something that\'s actually useful. By releasing new features and correcting possible bugs on a constant basis I can do just that, but I need your support. If you use it and intend to keep it, please sponsor its development by making a small <a target="_blank" href="http://shopify.freakdesign.com.au/#donate2">contribution</a>.</p><p>A small <a href="'+
a.data("help_file")+'" target="_blank">help guide</a> is avalable in PDF format.</p><p>Developers should consider using <a target="_blank" href="http://shopify.freakdesign.com.au/#ShopifyFD">ShopifyFD</a> to create the metafields this tool requires.</p>',"Custom Fields by Freakdesign",!0);return!1}),c=$("<li />",{});c.append(b);$("a.sidebar-link.dashboard").parent().before(c)}},init:function(){$("html").data("loaded",!0);$.ajax({type:"GET",url:"/admin/metafields.json",dataType:"json",error:function(){a.notice("Error reading shop metafields",
!0)},success:function(b){a.data("shop_metafields",b);for(var c=0,d=b.metafields.length;c<d;c++)if("whitelist"===b.metafields[c].key&&"custom_fields_config"===b.metafields[c].namespace){var f=b.metafields[c].value.replace(/\s/g,"").split(",");a.data("whitelist",f)}setInterval(function(){if(!$("#content").hasClass("loading")){a.load_ui();var b=document.URL.split("#")[0].split("?")[0].split("/"),b=b[b.length-2],c=document.URL.split("/").pop();b===a.data("alpha")&&c===a.data("omega")||"next"===c||"prev"===
c||(a.data("alpha",b),a.data("omega",c),"articles"!=a.data("alpha")||isNaN(a.data("omega"))?"pages"!=a.data("alpha")||isNaN(a.data("omega"))?"products"!=a.data("alpha")||isNaN(a.data("omega"))?"customers"!=a.data("alpha")||isNaN(a.data("omega"))?"orders"!=a.data("alpha")||isNaN(a.data("omega"))?"collections"!=a.data("alpha")||isNaN(a.data("omega"))?"smart_collections"!=a.data("alpha")||isNaN(a.data("omega"))?"custom_collections"!=a.data("alpha")||isNaN(a.data("omega"))||a.custom_fields_preload("collections"):
a.custom_fields_preload("collections"):(a.custom_fields_preload("collections"),console.log("collections")):a.custom_fields_preload():a.custom_fields_preload():a.custom_fields_preload():a.custom_fields_preload():a.custom_fields_preload())}},a.data("wait"));setInterval(function(){a.load_ui()},5E3);a.notice(a.translate("loaded"))}})}}}();a.load_css();a.init()}else alert("Not admin")}else alert("No jquery found!");else alert("Shopify javascript is not found. Are you in your admin?")})();