/*


      ############# 
    ##            *## 
   #        %      **#
  #        %%%    ***#
 #       %%F%D%%   ****#
#          %%%    *****#
#   ###     %     ###***# 
#  # ####       #### #**# 
#  #     #     #     #**# 
#   #####  # #  #####***# 
#         #   #  *******# 
 ### #           **# ### 
     # - - - - - - #                 
      | | | | | | |
	
     freakdesign.com               

CUSTOM FIELDS


*/
(function(){if(typeof Shopify!="undefined")if(typeof jQuery!="undefined")if(!$("html.freakdesign_custom_fields").length){var d=document,url=d.URL,html=$("html");html.addClass("freakdesign_custom_fields");if(url.indexOf("myshopify.com/admin")>1){var _=function(){var translation={no_fields:'<p class="msg box">No Product Custom Fields found</p>',no_fields_unique:'<p class="msg box">No Unique Custom Fields found. Don\'t worry - this is quite normal...</p>',error_get_metafields:"Error getting product metafields",
loaded:"Custom Field tool loaded"};var v={debug:false,author:"freakdesign",version:20131014,alpha:false,omega:false,wait:1E3,namespace:"custom_fields",namespace_new:"c_f",whitelist:[],key_articles:"[a]",key_collections:"[c]",key_pages:"[g]",key_products:"[p]",marker_collection:"[_c]",marker_file:"[_f]",marker_int:"[_i]",marker_page:"[_g]",marker_product:"[_p]",marker_textarea:"[_t]"};return{data:function(a,b){if("undefined"===typeof b)return v[a];v[a]=b},translate:function(a){return translation[a]},
notice:function(m,err){if(err)Shopify.Flash.error(m);else Shopify.Flash.notice(m)},escape_html:function(s){var div=document.createElement("div");div.appendChild(document.createTextNode(s));return div.innerHTML},unescape_html:function(s){if(s===undefined)return"";else{var div=document.createElement("div");div.innerHTML=s;var child=div.childNodes[0];return child?child.nodeValue:""}},fd_modal:function(show,content,title,persist){var my_fdmodal=$("#fdmodal");if(show){if(my_fdmodal.length)my_fdmodal.remove();
var m=$('<div id="fdmodal" class="modalWindow"><div class="main content"><header></header></div></div>');if(title)m.find("header").html("<h2>"+title+"</h2>");if(content){var d=$("<div/>",{}).append(content);m.find("div.main.content").append(d)}if(!persist)m.fadeIn().on("click",function(){_.fd_modal(false)});else{var mclose=$('<a href="#" class="close-modal">X</a>');mclose.on("click",function(){_.fd_modal(false);return false});m.find("header").prepend(mclose).end().fadeIn()}$("body").append(m)}else my_fdmodal.off("click").remove()},
load_css:function(){var css=document.createElement("link");css.type="text/css";css.rel="stylesheet";css.id="css_custom_fields";css.href="//rawgithub.com/freakdesign/shopify-custom-fields/master/freakdesign_custom_fields.css";document.body.appendChild(css)},get_json:function(p,callback,v){$.ajax({type:"GET",url:p,dataType:"json",success:function(d){callback(d);if(v)_.data(v,d)},fail:function(){_.notice("Error getting JSON",true)}})},get_collections:function(callback){if(typeof callback==="function")if(_.data("collections"))callback(_.data("collections"));
else _.get_json("/admin/collections.json",callback,"collections")},show_collections:function(d){},setup_product_preload:function(){$.ajax({type:"GET",url:"/admin/collections.json",dataType:"json",success:function(d){_.data("collections",d);_.setup_product()},error:function(){_.notice("Failed to preload all data. Expect errors...",true)}})},create_panel:function(d,i){var owner=d.metafields[i].owner_resource,key=d.metafields[i].key,namespace=d.metafields[i].namespace,myarray=_.data("fields"),meta_type=
_.key_check(key),to_append="",value=d.metafields[i].value;if(namespace!="global"&&namespace!="backups"){myarray.push(key);_.data("fields",myarray);key=_.clean_key(key);pdata="";to_append+='<div class="half">';if(d.metafields[i].value.length>1&&owner=="shop"){to_append+='<label for="product-type"><span class="tooltip tooltip-bottom"><span class="tooltip-container"><span class="tooltip-label">namespace: '+namespace+" | key: "+d.metafields[i].key+"</span></span>"+key+'</span><span class="note block ">'+
value+"</span></label>";value=""}else{pdata='data-mid="'+d.metafields[i].id+'" data-pid="'+_.data("omega")+'" ';to_append+='<label for="product-type" ><span class="tooltip tooltip-bottom"><span class="tooltip-container"><span class="tooltip-label">namespace: '+namespace+" | key: "+d.metafields[i].key+"</span></span>"+key+"</span></label>"}if(meta_type.field=="textarea")to_append+="<textarea "+pdata+'data-namespace="'+namespace+'" name="'+d.metafields[i].key+'" placeholder="'+key+'" data-key="'+d.metafields[i].key+
'" data-type="'+d.metafields[i].value_type+'">'+value+"</textarea>";else to_append+="<input "+pdata+'data-namespace="'+namespace+'" data-cffield="'+meta_type.field+'" data-cftype="'+meta_type.type+'" name="'+d.metafields[i].key+'" placeholder="'+key+'" value="'+value+'" data-key="'+d.metafields[i].key+'" data-type="'+d.metafields[i].value_type+'">';to_append+="</div>"}return to_append},clean_key:function(key){key=key.replace(/\[([^\]]*)\]*/g,"");key=key.charAt(0).toUpperCase()+key.slice(1).replace(/-/g,
" ").replace(/_/g," ");return key},setup_product:function(){var url="/admin/"+_.data("alpha")+"/"+_.data("omega")+"/metafields.json",custom_field_panel=$('<div class="row section"><div class="span6 section-summary"><h1>Product Custom Fields</h1><p>Custom Fields are created by your developer and shown here when using the Custom Fields tool. <b>These fields are available on all products.</b></p></div><div class="span18 section-content"></div></div>'),custom_field_product_panel=$('<div class="row section"><div class="span6 section-summary"><h1>Unique Custom Fields</h1><p>Unique Custom Fields are unique to this product and only shown here when using the Custom Fields tool.</p><p class="msg box warning">Be aware that if you save an empty field this will <b>delete</b> the metafield.</p></div><div class="span18 section-content"></div></div>'),
insertafter=$("div.row.section.inventory").eq(0),save=$('input[data-addclass-btn-primary="product.canSave"]').eq(0);insertafter.after(custom_field_panel,custom_field_product_panel);var a=$("<a/>",{"class":"btn","href":"#"}).text("Save with Custom Fields").on("click",function(){var inputs=$("div.custom_fields_box input, div.custom_fields_box textarea");if(inputs.length){var save_meta=function(i){var ci=inputs.eq(i),key=ci.attr("data-key"),value=ci.val(),ajax_type="POST",ns=ci.attr("data-namespace"),
value_type=ci.attr("data-type"),metaJSON={"metafield":{"namespace":ns,"key":key,"value":value,"value_type":value_type}};var ajax_url=url,skip=false;if(value.length==0&&(ci.attr("data-mid")&&ci.attr("data-pid"))){ajax_type="DELETE";ajax_url="/admin/products/"+ci.attr("data-pid")+"/metafields/"+ci.attr("data-mid")+".json"}else if(value.length==0)skip=true;if(!skip)$.ajax({type:ajax_type,url:ajax_url,dataType:"json",data:metaJSON,success:function(d){i++;if(i<inputs.length)save_meta(i);else save.click()},
fail:function(d){_.notice("Error saving custom fields",true)}});else{i++;if(i<inputs.length)save_meta(i);else save.click()}};save_meta(0)}return false});save.after(a);_.data("fields",[]);$.ajax({type:"GET",url:"/admin/metafields.json",dataType:"json",success:function(d){var to_append="",makerow=function(){return false};for(var i=0,len=d.metafields.length;i<len;i++){var namespace=d.metafields[i].namespace,namespace_len=namespace.length,whitelisted=false;if(_.data("whitelist").length>0)if($.inArray(namespace,
_.data("whitelist"))>-1)whitelisted=true;if(namespace===_.data("namespace")||(namespace===_.data("namespace_new")||whitelisted))to_append+=_.create_panel(d,i)}if(!to_append.length)to_append=_.translate("no_fields");custom_field_panel.find("div.section-content").append('<div class="custom_fields_box clearfix"><div class="content">'+to_append+"</div></div>");custom_field_panel.find('input[data-cftype="collection"]').each(function(){var t=$(this);t.after(_.build_select(t.attr("name")))});$.ajax({type:"GET",
url:url,dataType:"json",success:function(d){var to_append="";for(var i=0,len=d.metafields.length;i<len;i++){var whitelisted=false;if(_.data("whitelist").length>0)if($.inArray(d.metafields[i].namespace,_.data("whitelist"))>-1)whitelisted=true;if(d.metafields[i].namespace===_.data("namespace")||whitelisted)if($.inArray(d.metafields[i].key,_.data("fields"))<0)to_append+=_.create_panel(d,i);else{var input=$('input[data-key="'+d.metafields[i].key+'"],textarea[data-key="'+d.metafields[i].key+'"]');input.val(d.metafields[i].value).attr({"data-val":_.escape_html(d.metafields[i].value),
"data-mid":d.metafields[i].id,"data-pid":_.data("omega")})}}if(!to_append.length)to_append=_.translate("no_fields_unique");custom_field_product_panel.find("div.section-content").append('<div class="custom_fields_box clearfix"><div class="content">'+to_append+"</div></div>")},error:function(d){_.notice(_.translate("error_get_metafields"),true)}})},error:function(d){_.notice(_.translate("error_get_metafields"),true)}})},setup_page:function(a){},setup_article:function(a){},build_select:function(a){if(a){var c=
_.data("collections"),select=$("<select />",{"data-ref":a}).change(function(event){var t=$(this),v=t.val(),f=$('input[name="'+a+'"]').eq(0);if(v)f.val(v);else{var resetVal=_.unescape_html(f.attr("data-val"));resetVal?f.val(resetVal):f.val("")}});if(c&&Object.keys(c.collections).length>1){var options='<option value="">Pick a collection</option>';for(var i=0,len=Object.keys(c.collections).length;i<len;i++)options+='<option value="'+c.collections[i].handle+'">'+c.collections[i].title+"</option>";select.html(options);
return select}else _.notice("Error, invalid collection length",true)}},key_check:function(a){var c={field:"text",type:false,limit:false};if(a.indexOf(_.data("key_pages"))>0);else if(a.indexOf(_.data("key_products"))>0);else if(a.indexOf(_.data("key_articles"))>0);else if(a.indexOf(_.data("key_collections"))>0);if(a.indexOf(_.data("marker_collection"))>-1){c.field="select";c.type="collection"}else if(a.indexOf(_.data("marker_textarea"))>-1){c.field="textarea";c.type="string"}return c},init:function(){$.ajax({type:"GET",
url:"/admin/metafields.json",dataType:"json",error:function(){_.notice("Error reading shop metafields",true)},success:function(d){_.data("shop_metafields",d);for(var i=0,len=d.metafields.length;i<len;i++)if(d.metafields[i].key==="whitelist"&&d.metafields[i].namespace==="custom_fields_config"){var w=d.metafields[i].value.replace(/\s/g,"").split(",");_.data("whitelist",w)}var freakdesign_main_button=$("<a>",{id:"freakdesign_main_button"}).text("Custom Fields ON").on("click",function(){_.fd_modal(true,
'<p>Custom Fields is "honor-ware", which means that we trust each other to be nice. As the developer of it, I\'m committed to keep the tool something that\'s actually useful. By releasing new features and correcting possible bugs on a constant basis I can do just that, but I need your support. If you use it and intend to keep it, please sponsor its development by making a small <a target="_blank" href="http://shopify.freakdesign.com.au/#donate2">contribution</a>.</p><p>A small <a href="//freakdesign-us.s3.amazonaws.com/shopify/custom_fields/freakdesign-custom-fields-for-shopify-guide.pdf" target="_blank">help guide</a> is avalable in PDF format.</p><p>Developers should consider using <a target="_blank" href="http://shopify.freakdesign.com.au/#ShopifyFD">ShopifyFD</a> to create the metafields this tool requires.</p>',
"Custom Fields by Freakdesign",true);return false});var navli=$("<li />",{});navli.append(freakdesign_main_button);$("li[data-showif=\"'dashboard' | shopHasFeature\"]").before(navli);setInterval(function(){if(!$("#content").hasClass("loading")){var u_array=document.URL.split("#")[0].split("?")[0].split("/"),alpha=u_array[u_array.length-2],omega=document.URL.split("/").pop();if(alpha!==_.data("alpha")||omega!==_.data("omega")){_.data("alpha",alpha);_.data("omega",omega);if(_.data("alpha")=="articles"&&
!isNaN(_.data("omega")))_.setup_article();else if(_.data("alpha")=="pages"&&!isNaN(_.data("omega")))_.setup_page();else if(_.data("alpha")=="products"&&!isNaN(_.data("omega")))_.setup_product_preload()}}},_.data("wait"));_.notice(_.translate("loaded"))}})}}}();_.load_css();_.init()}else alert("not admin")}else alert("Already loaded the tool?");else alert("No jquery found!");else alert("Shopify javascript is not found. Are you in your admin?")})();